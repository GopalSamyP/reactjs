<!DOCTYPE html>
<html>
  <head>
    <title>Chatbot</title>
  </head>
  <body>
    <div class="js-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.19/dayjs.min.js"></script>
    <script src="https://unpkg.com/supersimpledev/react.js"></script>
    <script src="https://unpkg.com/supersimpledev/chatbot.js"></script>
    <script src="https://unpkg.com/supersimpledev/react-dom.js"></script>

    <script src="https://unpkg.com/supersimpledev/babel.js"></script>
    <script type="text/babel">
      function ChatInput({chatMessages, setChatMessages}) {

        const [inputValue, setInputValue] = React.useState('');
        function saveInput(event){
          setInputValue(event.target.value);
        }

        async function sendMessage(){

          const newChatMessages = [
              ...chatMessages,
              {
                message: inputValue,
                sender: 'user',
                id: crypto.randomUUID()
              }
            ];

            setChatMessages(newChatMessages);
            setInputValue('');

            const chatbotResponse = await Chatbot.getResponseAsync(inputValue);

            setChatMessages([
              ...newChatMessages,
              {
                message: chatbotResponse,
                sender: 'robot',
                id: crypto.randomUUID()
              }
            ]);
        }

        function handleTextInputOnKeyDown(event){

          if(event.key === 'Enter'){
            sendMessage();
          }else if(event.key === 'Escape'){
            setInputValue('');
          }
        }

        return (
          <>
            <input 
              type="text" 
              placeholder="Type your message..." 
              onChange={saveInput}
              onKeyDown={handleTextInputOnKeyDown}
              value={inputValue}
            />
            <button onClick={sendMessage}>Send</button>
          </>
        );
      }

      function ChatMessage({message, sender}) {
        return (
          <div>
            {sender === 'robot' && <img src="robot.png" width="50" />}
            {message}
            {sender === 'user' && <img src="user.png" width="50" />}
          </div>
        );
      }


      function ChatMessages({chatMessages}) {
        
        const chatMessageComponents = chatMessages.map((chatMessage) =>{
            return (<ChatMessage
              message={chatMessage.message}
              sender={chatMessage.sender}
              key={chatMessage.id}
            />)
        });

        return (
          <>
            {chatMessageComponents}
          </>
        );
      }

      function App(){

         const [chatMessages, setChatMessages] = React.useState([
          {
            message: 'Hello chatbot',
            sender: 'user',
            id: 'id1'
          },{
            message: 'Hello! how can I help you?',
            sender: 'robot',
            id: 'id2'
          },{
            message: 'Can you get me todays date?',
            sender: 'user',
            id: 'id3'
          },{
            message: 'Today is Feburary 08',
            sender: 'robot',
            id: 'id4'
          },{
            message: 'How about flip a coin',
            sender: 'user',
            id: 'id5'
          },{
            message: 'You got heads!',
            sender: 'robot',
            id: 'id6'
          }
        ]);
        
        // const [chatMessages, setChatMessages] = chatMessageState;
        // const chatMessages = chatMessageState[0];
        // const setChatMessages = chatMessageState[1];

        return (
          <div>
            <ChatInput chatMessages={chatMessages} setChatMessages={setChatMessages}/>
            <ChatMessages chatMessages={chatMessages} />
          </div>
        );
      }

      const container = document.querySelector('.js-container');
      ReactDOM.createRoot(container).render(<App />);
    </script>
  </body>
</html>